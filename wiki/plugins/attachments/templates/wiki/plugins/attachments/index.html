{% extends "wiki/base.html" %}
{% load wiki_tags i18n humanize %}
{% load url from future %}

{% block pagetitle %}{% trans "Attachments" %}: {% article_for_object urlpath as article %}{{ article.current_revision.title }}{% endblock %}

{% block wiki_breadcrumbs %}
  {% include "wiki/includes/breadcrumbs.html" %}
{% endblock %}

{% block wiki_contents %}

  {% article_for_object urlpath as article %}

  {% if article %}
    <div class="tabbable tabs-top" style="margin-top: 40px;">
      <ul class="nav nav-tabs">
        {% with "attachments" as selected %}
          {% include "wiki/includes/article_menu.html" %}
        {% endwith %}
        <li>
          <h1 style="margin-top: -10px;">
            {{ article.current_revision.title }}
          </h1>
        </li>
      </ul>
      <div class="tab-content">
        <div class="row-fluid">
          <div class="span6">
            <h2>{% trans "Attachments" %}</h2>
            {% for attachment in attachments %}
              <table class="table table-bordered table-striped" style="width: 100%;">
              <tr>
                <td colspan="4">
                  <h3>
                    <a href="{% url 'wiki:attachments_download' path=urlpath.path attachment_id=attachment.id %}">{{ attachment.current_revision.get_filename }}</a>
                    <span class="badge">{{ attachment.current_revision.created|naturaltime }}</span>
                    {% if attachment.current_revision.deleted %}
                    <span class="badge badge-important">{% trans "deleted" %}</span>
                    {% endif %}
                  </h3>
                  {{ attachment.current_revision.description }}
                </td>
              </tr>
              <tr>
                <th>{% trans "Markdown tag" %}</th>
                <th>{% trans "Uploaded by" %}</th>
                <th>{% trans "Size" %}</th>
                <td style="text-align: right;" rowspan="2">
                  {% if attachment|can_write:user %}
                    <p>
                    {% if not attachment.current_revision.deleted %}
                      <a href="{% url 'wiki:attachments_replace' path=urlpath.path attachment_id=attachment.id %}" class="btn">{% trans "Replace" %}</a>
                      {% if attachment.article = article %}
                        <a href="{% url 'wiki:attachments_delete' path=urlpath.path attachment_id=attachment.id %}" class="btn">{% trans "Delete" %}</a>
                      {% else %}
                        <a href="{% url 'wiki:attachments_delete' path=urlpath.path attachment_id=attachment.id %}" class="btn">{% trans "Detach" %}</a>
                      {% endif %}
                    {% else %}
                      {% if attachment.current_revision.previous_revision.id %}
                      <form method="POST" action="{% url 'wiki:attachments_revision_change' path=urlpath.path attachment_id=attachment.id revision_id=attachment.current_revision.previous_revision.id %}">
                        {% csrf_token %}
                        <button class="btn">
                          {% trans "Restore" %}
                        </button>
                      </form>
                      {% endif %}
                    {% endif %}
                    </p>
                  {% endif %}
                  <p>
                  <a href="{% url 'wiki:attachments_history' path=urlpath.path attachment_id=attachment.id %}">
                    <span class="icon-time"></span>
                    {% trans "File history" %} ({{ attachment.attachmentrevision_set.all.count }} {% trans "revisions" %})
                  </a>
                  </p>
                </td>
              </tr>
              <tr>
                <td><code>[attachment:{{ attachment.id }}]</code></td>
                <td>
                {% if attachment.current_revision.user %}{{ attachment.current_revision.user }}{% else %}{% if user|is_moderator %}{{ attachment.current_revision.ip_address|default:"anonymous (IP not logged)" }}{% else %}{% trans "anonymous (IP logged)" %}{% endif %}{% endif %}
                </td>
                <td>{{ attachment.current_revision.get_size|filesizeformat }}</td>
              </tr>
              </table>
            {% empty %}
              <p style="margin-bottom: 20px;"><em>{% trans "There are no attachments for this article." %}</em></p>
            {% endfor %}
          </div>
          <div class="span6">
            <div class="well">
              <h2>{% trans "Add from upload" %}</h2>
              <form method="POST" class="form-vertical" id="attachment_form" enctype="multipart/form-data">
              {% wiki_form form %}
                <button type="submit" name="save" value="1" class="btn">
                  <span class="icon-upload"></span>
                  {% trans "Upload file" %}
                </button>
              </form>
            </div>
            <div class="well">
              <h2>{% trans "Add from existing attachments..." %}</h2>
              <p>{% trans "You can reuse files from other articles. Please note that these files are subject to updates on other articles." %}</p>
              <form method="GET" action="{% url 'wiki:attachments_search' path=urlpath.path %}" class="form-search">
                {{ search_form.query }}
                <button class="btn">
                  <span class="icon-search"></span>
                  {% trans "Search files and articles" %}
                </button>
              </form>
            </div>
          </div>
        </div>
        
      </div>
    </div>

    <div class="tabbable tabs-below" style="margin-top: 20px;">
      <ul class="nav nav-tabs">
        <li style="margin-top: 10px;"><em>{% trans "Article last modified:" %} {{ article.current_revision.modified }}</em></li>
      </ul>
    </div>
    
  {% else %}
    {% trans "An article for this path does not exist." %}
  {% endif %}
  
{% endblock %}

